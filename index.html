<!DOCTYPE html>
<html>
<head>
<title>Orange Test Loader </title>
<link rel="author" title="Orange" href="http://www.orange.com/" />
<style type="text/css">
	html, body {
		background-color: lightgrey;
        width: 100%;
        height: 100%;
        margin: 0px;
        font-family: Arial, Verdana, Helvetica, sans-serif;
	}
    #header {
        width: 100%;
        height: 5%;
        background-color: #5A5C61;
        color: white;
        display: table;
    }
    #header > * {
        display: table-cell;
    }
    #CurrentTest {
        width: 300px;
        overflow: hidden;
    }
    #test {
        width: 100%;
        height: 95%;
    }
</style>
<script>
var oTestFrame;

var iUrl=0;
var oTests;
var oLog  = new Array();
var oComment  = new Array();
var oTimer;
var bTimerRunning;
var iCallbacks;

function CheckForResult()
{
    iCallbacks++;

    try
    {
        oTestWindow = window.parent.document.getElementById('test').contentWindow;

        if (oTestWindow.document.readyState == "complete")
        {
            oPass = oTestWindow.document.getElementsByClassName("pass");
            oFail = oTestWindow.document.getElementsByClassName("fail");

            if (oPass.length > 0 && oFail.length == 0)
            {
                log('Pass');
            }  
            else if( oFail.length > 0)
            {
                log('Fail');
            }
        }
    }
    catch(e){}
}

function updateStatus() {
    document.getElementById('CurrentTest').innerHTML =  "Test #" + (iUrl+1) + "/" + (oTests.length-1) + " [" + oTests[iUrl] + "]";
}

function init()
{
    var uri  = "./tests-list.txt";
   
    xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange  = function()
    { 
        if(xmlhttp.readyState  == 4)
        {
            var fileData = xmlhttp.responseText;
            oTests = fileData.split('\n');

			// remove commented lines
			var reg=new RegExp('^#','g');
			for (var x=0;x<(oTests.length-1);) {
				if (reg.test(oTests[x]) == true) {
					oTests.splice(x, 1);
					x--;
				}
				else {
					x++;
				}
			}

			// remove empty lines
			var reg=new RegExp('^\\s*$','g');
			for (var x=0;x<(oTests.length-1);) {
				if (reg.test(oTests[x]) == true) {
					oTests.splice(x, 1);
					x--;
				}
				else {
					x++;
				}
			}

            for (var x=0;x<(oTests.length-1);x++)
            {
                oLog[x] = 'No Result';
                oTests[x] = oTests[x].replace(/\r/, '');
				oComment[x] = '0';
            }

            oTestFrame = document.getElementById('test');
            oTestFrame.src = oTests[iUrl];
            updateStatus();

            oTimer = setInterval("CheckForResult()", 5000);
            bTimerRunning = true;
            iCallbacks = 0;
        }
    }; 

    xmlhttp.open("GET", uri, true);
    xmlhttp.send(null);

}

function log(result)
{
    oLog[iUrl] = result;
	comment = oTestWindow.document.getElementById('results').innerHTML;
	nbPass = oTestWindow.document.getElementsByClassName("pass").length;
    nbFail = oTestWindow.document.getElementsByClassName("fail").length;
	nbPass = (nbPass==0) ? 0 : nbPass - 1;
	nbFail = (nbFail==0) ? 0 : nbFail - 1;
	//oComment[iUrl] = nbPass + "/" + (nbPass+nbFail) + " succeed (" + nbPass + " " + nbFail + ")";
	oComment[iUrl] = nbPass + "/" + (nbPass+nbFail);
	
    next();
}

function next()
{
    if (bTimerRunning)
    {
        clearInterval(oTimer);
        bTimerRunning = false;
        iCallbacks = 0;
    }

    if (iUrl<(oTests.length-2))
    {
        iUrl++;
        oTestFrame.src = oTests[iUrl] ;
        updateStatus();

        oTimer = setInterval("CheckForResult()", 5000);
        bTimerRunning = true;
        iCallbacks = 0;
    }
    else
    {
        updateStatus();
        oTestFrame.src = "./results.html";
    }
}

function TestResults()
{
    results = new Array();
    for (var x=0;x<oLog.length;x++)
    {
        results.push({test:oTests[x],log:oLog[x],comment:oComment[x]});
    }
    return results;
}
</script>
    </head>
    <body>
        <div id="header">
          <h1>OrangeMark</h1>
          <h2>Browser Graphics Performance Test Suite</h2>
          <div id="CurrentTest"></div>
          <p>Press any key to skip</p>
        </div>
        <iframe id='test' frameborder="0" scrolling="no">
        </iframe>
    </body>
    <script type='text/javascript'>
        init();
        document.addEventListener('keypress',
            function(evt) {
                next();
            },
            false);
    </script>
</html>
