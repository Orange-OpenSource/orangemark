<!DOCTYPE html>
<html>
<head>
<title>Orange Test Loader </title>
<link rel="author" title="Orange" href="http://www.orange.com/" />
<style type="text/css">
	body {
		background-color: lightgrey;
	}
    #Container
    {
        display: table;
        width: 100%;
    }
    div
    {
       display: table-cell;
    } 
    #left
    {
        float: none;
        text-align: left;
    } 
    #right
    {
        text-align: right;
    }
</style>
<script>
var oTestFrame;

var iUrl=0;
var oTests;
var oLog  = new Array();
var oComment  = new Array();
var oTimer;
var bTimerRunning;
var iCallbacks;

function CheckForResult()
{
    iCallbacks++;

    try
    {
        oTestWindow = window.parent.document.getElementById('test').contentWindow;

        if (oTestWindow.document.readyState == "complete")
        {
            oPass = oTestWindow.document.getElementsByClassName("pass");
            oFail = oTestWindow.document.getElementsByClassName("fail");

            if (oPass.length > 0 && oFail.length == 0)
            {
                log('Pass');
            }  
            else if( oFail.length > 0)
            {
                log('Fail');
            }
        }
    }
    catch(e){}
}

function init()
{
    var uri  = "./tests-list.txt";
   
    xmlhttp = new XMLHttpRequest();

    xmlhttp.onreadystatechange  = function()
    { 
        if(xmlhttp.readyState  == 4)
        {
            var fileData = xmlhttp.responseText;
            oTests = fileData.split('\n');

			// remove commented lines
			var reg=new RegExp('^#','g');
			for (var x=0;x<(oTests.length-1);) {
				if (reg.test(oTests[x]) == true) {
					oTests.splice(x, 1);
					x--;
				}
				else {
					x++;
				}
			}

			// remove empty lines
			var reg=new RegExp('^\\s*$','g');
			for (var x=0;x<(oTests.length-1);) {
				if (reg.test(oTests[x]) == true) {
					oTests.splice(x, 1);
					x--;
				}
				else {
					x++;
				}
			}

            for (var x=0;x<(oTests.length-1);x++)
            {
                oLog[x] = 'No Result';
                oTests[x] = oTests[x].replace(/\r/, '');
				oComment[x] = '0';
            }

            oTestFrame = window.parent.document.getElementById('test');
            oTestFrame.src = oTests[iUrl];
            document.getElementById('CurrentTest').innerHTML =  "Test #" + (iUrl+1) + "/" + (oTests.length-1) + "(" + oLog[iUrl] + ") " + oTests[iUrl];

            oTimer = setInterval("CheckForResult()", 5000);
            bTimerRunning = true;
            iCallbacks = 0;
        }
    }; 

    xmlhttp.open("GET", uri, true);
    xmlhttp.send(null);

}

function log(result)
{
    oLog[iUrl] = result;
	comment = oTestWindow.document.getElementById('results').innerHTML;
	nbPass = oTestWindow.document.getElementsByClassName("pass").length;
    nbFail = oTestWindow.document.getElementsByClassName("fail").length;
	nbPass = (nbPass==0) ? 0 : nbPass - 1;
	nbFail = (nbFail==0) ? 0 : nbFail - 1;
	//oComment[iUrl] = nbPass + "/" + (nbPass+nbFail) + " succeed (" + nbPass + " " + nbFail + ")";
	oComment[iUrl] = nbPass + "/" + (nbPass+nbFail);
	
    next();
}

function next()
{
    if (bTimerRunning)
    {
        clearInterval(oTimer);
        bTimerRunning = false;
        iCallbacks = 0;
    }

    if (iUrl<(oTests.length-2))
    {
        iUrl++;
        oTestFrame.src = oTests[iUrl] ;
        document.getElementById('CurrentTest').innerHTML =  "Test #" + (iUrl+1) + "/" + (oTests.length-1) + "(" + oLog[iUrl] + ") " + oTests[iUrl];

        oTimer = setInterval("CheckForResult()", 5000);
        bTimerRunning = true;
        iCallbacks = 0;
    }
    else
    {
        document.getElementById('CurrentTest').innerHTML = "Test #" + (iUrl+1) + "/" + (oTests.length-1) + "(" + oLog[iUrl] + ") " + oTests[iUrl];
        oTestFrame.src = "./results.html";
    }
}

function last()
{
    if (bTimerRunning)
    {
        clearInterval(oTimer);
        bTimerRunning = false;
        iCallbacks = 0;
    }

    if (iUrl>0)
    {
        iUrl--;
        oTestFrame.src = oTests[iUrl] ;
        document.getElementById('CurrentTest').innerHTML = "Test #" + (iUrl+1) + "/" + (oTests.length-1) + "(" + oLog[iUrl] + ") " + oTests[iUrl];
    }
    else
    {
        document.getElementById('CurrentTest').innerHTML = "Test #" + (iUrl+1) + "/" + (oTests.length-1) + "(" + oLog[iUrl] + ") " + oTests[iUrl];
    }
}

function TestResults()
{
    results = new Array();
    for (var x=0;x<oLog.length;x++)
    {
        results.push({test:oTests[x],log:oLog[x],comment:oComment[x]});
    }
    return results;
}
</script>
    </head>
    <body>
          <div id="CurrentTest"></div>
          <div id="Container">
            <div id="left">
                <button id="Pass" accesskey="P" onclick="log('Pass');">Pass</button>
                <button id="Fail" accesskey="F" onclick="log('Fail');">Fail</button>
                <button id="Not Implemented" accesskey="F" onclick="log('Not Implemented');">Not Implemented</button>
                <button id="last" accesskey="L" onclick="last();">&lt;&lt; Last</button>			
                <button id="Next" accesskey="N" onclick="next();">Next &gt;&gt;</button>
            </div>
        </div>
    </body>
    <script type='text/javascript'>
        init();
    </script>
</html>
